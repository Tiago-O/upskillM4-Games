<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <div class="container text-center my-2 w-75">
        <h1 class="mb-5">History</h1>

        <div class="w-100 my-4 border border-secondary">
            <div class="text-center my-2">
                <h4>Connect Four</h4>
            </div>
            <div class="row my-2">
                <div id="connect-four-champion-name" class="col"></div>
                <div id="connect-four-champion-freq" class="col"></div>
            </div>
            <div class="row my-2">
                <div id="connect-four-last-played"></div>
            </div>
        </div>

        <a type="button" href="menu.html" class="btn btn-outline-secondary w-100 my-5">Return to Menu</a>

    </div>

</body>

<script>

    // history list
    let retrievedData = localStorage.getItem('history');
    let history = JSON.parse(retrievedData);
    if(!history) {
        history = [];
    }

    let boxConnectFourChampion = $('#connect-four-champion-name');
    let boxConnectFourChampionFreq = $('#connect-four-champion-freq');
    let connectFourChampion = champion(history);
    // let connectFourChampionFreq = champFrequency(winnersFrequency(history), connectFourChampion);
    let connectFourChampionVics = champVictories(winnersFrequency(history))[1];

    let boxConnectFourLastPlayed = $('#connect-four-last-played');
    let connectFourLast = history[history.length - 1]

    if (history) {
        boxConnectFourChampion.text(`Champion: ${connectFourChampion}`);
        boxConnectFourChampionFreq.text(`${connectFourChampionVics} victories`);
        boxConnectFourLastPlayed.text(`Last time played ${formatDate(connectFourLast.timestamp)} at ${formatTime(connectFourLast.timestamp)} (${connectFourLast.player1} vs ${connectFourLast.player2}) winner: ${connectFourLast.winner}`);
    } else {
        boxConnectFourChampion.text(
            'Never played :('
        );
    }

    function champion(history) {
        if (history.length === 0) {
            return false;
        }
        let champList = history.map(function (game) {
            return game.winner;
        });
        return getMostFrequent(champList);
    }

    // https://javascript.plainenglish.io/how-to-find-the-most-frequent-element-in-an-array-in-javascript-c85119dc78d2
    function getMostFrequent(arr) {
        const hashmap = arr.reduce( (acc, val) => {
            acc[val] = (acc[val] || 0 ) + 1
            return acc
        },{})
        return Object.keys(hashmap).reduce((a, b) => hashmap[a] > hashmap[b] ? a : b)
    }

    function winnersFrequency(history) {
        let winnersFrequency = {};
        history.forEach(function (game) {
            if (winnersFrequency[game.winner]) {
                return winnersFrequency[game.winner] += 1;
            } else {
                return winnersFrequency[game.winner] = 1;
            }
        });
        return winnersFrequency;
    }

    function champFrequency(winnerFrequency, champion) {
        return winnerFrequency[champion];
    }

    // returns list with champion and n victories
    function champVictories(winnersFrequency) {
        let winners = Object.entries(winnersFrequency);
        let champVictories = [winners[0][0], winners[0][1]];
        for (let i = 0; i < winners.length; i++) {
            if (winners[i][1] > champVictories[1]) {
                champVictories = [winners[i][0], winners[i][1]];
            }
        }
        return champVictories;
    }

    // format Date.now()
    function formatDate(date) {
        let d = new Date(date),
            year = d.getFullYear(),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate();

        if (month.length < 2)
            month = '0' + month;
        if (day.length < 2)
            day = '0' + day;

        return [day, month, year].join('/');
    }

    function formatTime(time) {
        let t = new Date(time),
            hour = t.getHours(),
            min = '' + t.getMinutes(),
            sec = '' + t.getSeconds();

        if (min.length < 2)
            min = '0' + min;
        if (sec.length < 2)
            sec = '0' + sec;

        return [hour, min, sec].join(':');
    }

</script>

</html>
